# Edge ANPR Service

































































































































    main()if __name__ == '__main__':        cap.release()    finally:                last_send = now                    print('Failed to POST detection:', e)                except Exception as e:                    print('POST', payload, '->', resp.status_code, resp.text[:200])                    resp = requests.post(args.endpoint, headers=headers, data=json.dumps(payload), timeout=5)                try:                # send snapshot as multipart if desired; here we're sending JSON only                }                    'x-api-key': args.api_key,                    'Content-Type': 'application/json',                headers = {                }                    'timestamp': int(time.time()),                    'camera_id': args.rtsp,                    'confidence': best_conf,                    'plate_number': best_text,                payload = {                img_b64 = img_enc.tobytes()                _, img_enc = cv2.imencode('.jpg', snapshot)                snapshot = cv2.resize(frame_small[sy:sy+sh, sx:sx+sw], (sw*scale, sh*scale))                scale = 2                sx, sy, sw, sh = best_box                # crop original frame for snapshot            if best_text:                        best_box = (x, y, w, h)                        best_text = text                        best_conf = conf                    if conf > best_conf:                    conf = min(100, int(len(text) / 8.0 * 100))                    # crude confidence: length normalized                if len(text) >= 5:                text = ocr_plate(roi)                roi = gray[y:y+h, x:x+w]            for (x, y, w, h) in candidates:            best_box = None            best_conf = 0            best_text = ''            candidates = detect_plate_like_regions(gray)            gray = cv2.cvtColor(frame_small, cv2.COLOR_BGR2GRAY)            frame_small = cv2.resize(frame, (0, 0), fx=0.5, fy=0.5)            # resize for faster processing                continue            if now - last_send < args.interval:            now = time.time()                continue                time.sleep(0.5)            if not ret:            ret, frame = cap.read()        while True:    try:    last_send = 0        return        print('Failed to open stream:', args.rtsp)    if not cap.isOpened():    cap = cv2.VideoCapture(args.rtsp)    args = parser.parse_args()    parser.add_argument('--min-confidence', type=int, default=70, help='minimum OCR confidence (heuristic)')    parser.add_argument('--interval', type=float, default=1.0, help='seconds between frames to process')    parser.add_argument('--api-key', required=True)    parser.add_argument('--endpoint', required=True)    parser.add_argument('--rtsp', required=True)    parser = argparse.ArgumentParser()def main():    return text    text = ''.join(ch for ch in text if ch.isalnum())    text = pytesseract.image_to_string(img, config=config)    config = '--psm 7 -c tessedit_char_whitelist=ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'def ocr_plate(img):    return candidates            candidates.append((x, y, w, h))        if 2.0 > ar > 0.8 and w > 60 and h > 15:        ar = w / float(h) if h > 0 else 0        x, y, w, h = cv2.boundingRect(cnt)    for cnt in contours:    candidates = []    contours, _ = cv2.findContours(edged.copy(), cv2.RETR_TREE, cv2.CHAIN_APPROX_SIMPLE)    edged = cv2.Canny(blurred, 50, 200)    blurred = cv2.GaussianBlur(gray, (5, 5), 0)def detect_plate_like_regions(gray):# Simple plate-like region extraction using contours and aspect ratio filteringimport requestsimport pytesseractimport numpy as npimport cv2import jsonimport timeimport argparse"""- Adjust confidence thresholds and post-processing for your cameras and region.- This script is intentionally simple and for demonstration only.Notes:    python edge_anpr.py --rtsp "rtsp://user:pass@camera:554/stream" --endpoint "https://your-server/api/camera/vehicle-entry" --api-key "secret"Usage:- Tesseract OCR installed on the system and in PATH (or specify pytesseract.pytesseract.tesseract_cmd)- pip install opencv-python-headless pytesseract requests numpy- Python 3.10+Requirements:PlateRecognizer API) or a pre-trained detection+OCR pipeline.license-plate recognition. For production, integrate a dedicated ANPR engine (OpenALPR, Sighthound,This example uses OpenCV to capture frames from an RTSP stream and Tesseract OCR to attemptThis folder contains a minimal Python script example that connects to an RTSP stream, captures frames on motion (simplified), performs plate recognition using OpenALPR or OpenCV+OCR, and POSTs detections to the ERM API.

See `edge_anpr.py` for the script.
